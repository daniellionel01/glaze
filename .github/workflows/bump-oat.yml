name: Bump Oat Version

on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get latest Oat release
        id: latest
        run: |
          tag=$(curl -fsSL "https://api.github.com/repos/knadh/oat/releases/latest" | jq -r .tag_name)
          version="${tag#v}"
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Read current version
        id: current
        run: |
          current=$(grep -Eo 'pub const version = "[^"]+"' "glaze_oat/src/glaze_oat.gleam" | sed -E 's/.*"([^"]+)"/\1/')
          echo "version=$current" >> "$GITHUB_OUTPUT"

      - name: Stop if already up to date
        if: steps.latest.outputs.version == steps.current.outputs.version
        run: echo "Already up to date"

      - name: Update version constant
        if: steps.latest.outputs.version != steps.current.outputs.version
        run: |
          sed -i 's/pub const version = ".*"/pub const version = "${{ steps.latest.outputs.version }}"/' "glaze_oat/src/glaze_oat.gleam"

      - name: Create pull request
        if: steps.latest.outputs.version != steps.current.outputs.version
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/bump-oat-${{ steps.latest.outputs.version }}
          commit-message: "chore: bump oat to ${{ steps.latest.outputs.version }}"
          title: "chore: bump Oat to ${{ steps.latest.outputs.version }}"
          body: |
            Updates `glaze_oat/src/glaze_oat.gleam`:
            - `pub const version` -> `${{ steps.latest.outputs.version }}`

            Source release:
            - https://github.com/knadh/oat/releases/latest
